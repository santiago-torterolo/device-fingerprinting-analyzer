{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Dashboard Overview</h2>
    <button class="btn btn-primary" onclick="window.location.reload()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card p-3 border-left-primary">
            <h6 class="text-muted">Total Devices</h6>
            <h3>{{ stats.total_devices }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3">
            <h6 class="text-muted">Total Accounts</h6>
            <h3>{{ stats.total_accounts }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3">
            <h6 class="text-muted">Crossings Detected</h6>
            <h3>{{ stats.total_crossings }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3">
            <h6 class="text-muted">Avg Risk Score</h6>
            <h3 class="{{ 'text-danger' if stats.avg_risk > 50 else 'text-success' }}">
                {{ "%.1f"|format(stats.avg_risk) }}
            </h3>
        </div>
    </div>
</div>

<div class="row">
    <!-- Top Risky Devices -->
    <div class="col-md-8">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Top High-Risk Devices</h5>
                <span class="badge bg-light text-dark">Top 10</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>OS / Browser</th>
                                <th>Risk Level</th>
                                <th>Score</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in top_devices %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-3 bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                            <i class="fas {{ 'fa-laptop' if device.os == 'Windows' or device.os == 'macOS' else 'fa-mobile-alt' }} text-secondary"></i>
                                        </div>
                                        <div>
                                            <span class="fw-bold">{{ device.os }}</span><br>
                                            <small class="text-muted">{{ device.browser }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if device.risk_level == 'high' else 'warning' }}">
                                        {{ device.risk_level|upper }}
                                    </span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 6px; width: 60px;">
                                        <div class="progress-bar bg-{{ 'danger' if device.risk_level == 'high' else 'warning' }}" 
                                             role="progressbar" style="width: {{ device.risk_score }}%"></div>
                                    </div>
                                    <small>{{ "%.1f"|format(device.risk_score) }}</small>
                                </td>
                                <td>
                                    <a href="{{ url_for('views.device_detail', device_id=device.device_id) }}" 
                                       class="btn btn-sm btn-primary">Details</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Alerts & Risk Rules -->
    <div class="col-md-4">
        <!-- Live Alerts Feed -->
        <div class="card shadow-sm border-0 mb-4 bg-dark text-white">
            <div class="card-header bg-transparent border-secondary d-flex justify-content-between">
                <h6 class="mb-0"><i class="fas fa-satellite-dish me-2 text-danger"></i> Live Security Feed</h6>
                <div class="spinner-grow spinner-grow-sm text-danger" role="status"></div>
            </div>
            <div class="card-body p-0" style="max-height: 250px; overflow-y: auto;" id="alerts-feed">
                <!-- Loaded via JS -->
                <div class="p-4 text-center text-muted">Scanning network...</div>
            </div>
        </div>

        <!-- Risk Scoring Rules -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0">Active Scoring Rules</h6>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="rules-list">
                    <!-- Loaded via JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- OS Distribution Chart -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white"><h6 class="mb-0 fw-bold">OS Distribution</h6></div>
            <div class="card-body">
                <div id="os-chart" style="height: 250px;"></div>
            </div>
        </div>
    </div>
    <!-- Browser Distribution Chart -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white"><h6 class="mb-0 fw-bold">Browser Distribution</h6></div>
            <div class="card-body">
                <div id="browser-chart" style="height: 250px;"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Fetch Rules
fetch('/api/rules')
    .then(res => res.json())
    .then(rules => {
        const list = document.getElementById('rules-list');
        list.innerHTML = '';
        rules.forEach(r => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
            item.innerHTML = `
                <div>
                    <span class="small d-block fw-bold">${r.rule}</span>
                    <span class="badge bg-light text-dark" style="font-size: 0.65rem;">${r.category}</span>
                </div>
                <span class="text-danger small">+${r.weight} pts</span>
            `;
            list.appendChild(item);
        });
    });

// Fetch Alerts
function loadAlerts() {
    fetch('/api/alerts')
        .then(res => res.json())
        .then(alerts => {
            const feed = document.getElementById('alerts-feed');
            feed.innerHTML = '';
            alerts.forEach(a => {
                const item = document.createElement('div');
                item.className = 'p-3 border-bottom border-secondary';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-danger small"><i class="fas fa-exclamation-triangle"></i> Alert</span>
                        <small class="text-muted" style="font-size: 0.7rem;">${a.timestamp.split('T')[1].substring(0,5)}</small>
                    </div>
                    <p class="mb-0 small">${a.message}</p>
                `;
                feed.appendChild(item);
            });
        });
}
loadAlerts();
setInterval(loadAlerts, 10000);

// Charts
fetch('/api/stats/distribution')
    .then(res => res.json())
    .then(data => {
        // OS Chart
        new ApexCharts(document.querySelector("#os-chart"), {
            series: data.os.map(i => i.value),
            chart: { type: 'donut', height: 250 },
            labels: data.os.map(i => i.label),
            colors: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'],
            legend: { position: 'bottom' }
        }).render();

        // Browser Chart
        new ApexCharts(document.querySelector("#browser-chart"), {
            series: [{ data: data.browser.map(i => i.value) }],
            chart: { type: 'bar', height: 250 },
            plotOptions: { bar: { borderRadius: 4, horizontal: true }},
            xaxis: { categories: data.browser.map(i => i.label) },
            colors: ['#4e73df']
        }).render();
    });
</script>
{% endblock %}
