{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Compliance & Risk Report</h2>
    <div class="btn-group">
        <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
            <i class="fas fa-print me-2"></i> Print Report
        </button>
        <button class="btn btn-primary btn-sm">
            <i class="fas fa-download me-2"></i> Export CSV
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-white">GDPR Compliance Summary</div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Data Retention (90 days)</span>
                        <span class="text-success"><i class="fas fa-check-circle"></i> Compliant</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>PII Hashing (SHA-256)</span>
                        <span class="text-success"><i class="fas fa-check-circle"></i> Enabled</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>User Request Deletion</span>
                        <span class="text-success"><i class="fas fa-check-circle"></i> Active</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-white">Fraud Ring Detection Metrics</div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-4">
                        <small class="text-muted d-block">Identified Rings</small>
                        <h3 class="text-danger">12</h3>
                    </div>
                    <div class="col-6 mb-4">
                        <small class="text-muted d-block">Accounts Blocked</small>
                        <h3 class="text-primary">45</h3>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">Detection Accuracy</small>
                        <h3>94.2%</h3>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">False Positives</small>
                        <h3 class="text-warning">1.4%</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header bg-white">Risk Concentration Heatmap (By Day & Hour)</div>
    <div class="card-body p-0">
        <div id="heatmap-container" style="width: 100%; height: 350px; background: #fff;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const margin = { top: 30, right: 30, bottom: 40, left: 60 };
const container = document.getElementById('heatmap-container');
const width = container.clientWidth - margin.left - margin.right;
const height = 350 - margin.top - margin.bottom;

const svg = d3.select("#heatmap-container")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left}, ${margin.top})`);

const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
const hours = Array.from({length: 24}, (_, i) => i + ":00");

// Labels for scales
const x = d3.scaleBand()
    .range([ 0, width ])
    .domain(hours)
    .padding(0.05);
svg.append("g")
    .style("font-size", "9px")
    .attr("transform", `translate(0, ${height})`)
    .call(d3.axisBottom(x).tickSize(0))
    .select(".domain").remove();

const y = d3.scaleBand()
    .range([ height, 0 ])
    .domain(days)
    .padding(0.05);
svg.append("g")
    .style("font-size", "11px")
    .call(d3.axisLeft(y).tickSize(0))
    .select(".domain").remove();

// Color scale
const myColor = d3.scaleLinear()
    .range(["#f8f9fa", "#dc3545"])
    .domain([1, 100]);

// Generate mock data for the heatmap
const data = [];
days.forEach(d => {
    hours.forEach(h => {
        data.push({
            group: h,
            variable: d,
            value: Math.floor(Math.random() * 100)
        });
    });
});

// Tooltip
const tooltip = d3.select("#heatmap-container")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")
    .style("position", "absolute");

svg.selectAll()
    .data(data, d => d.group+':'+d.variable)
    .join("rect")
    .attr("x", d => x(d.group))
    .attr("y", d => y(d.variable))
    .attr("rx", 4)
    .attr("ry", 4)
    .attr("width", x.bandwidth() )
    .attr("height", y.bandwidth() )
    .style("fill", d => myColor(d.value))
    .style("stroke-width", 4)
    .style("stroke", "none")
    .style("opacity", 0.8)
    .on("mouseover", (event, d) => {
        tooltip.style("opacity", 1);
        d3.select(event.currentTarget).style("stroke", "black").style("opacity", 1);
    })
    .on("mousemove", (event, d) => {
        tooltip
          .html("Risk Density: " + d.value + "%")
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 10) + "px");
    })
    .on("mouseleave", (event, d) => {
        tooltip.style("opacity", 0);
        d3.select(event.currentTarget).style("stroke", "none").style("opacity", 0.8);
    });
</script>
{% endblock %}
